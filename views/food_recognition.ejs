<%- include("parts/html-head") %>
<%- include("parts/navbars") %>

<style>
  body {
    margin: 85px;
    margin-top: 10px;
  }

  form-group {
    border: 5px
  }

  table {
    width: "200px";
  }

  div.table-responsive {
    width: 800px;
  }

  /* #upload {
    width: 550px;
  } */
</style>

<div class="row justify-content-center mt-4">
  <img width="800px" height="450px" alt="Image" src="/img/ai03.jpg">
</div>

<div class="container mt-5">
 
  <div class="row justify-content-between">
    <div class="col-lg-6">
      <div class="card-body">
        <h4 class="card-title">Custom File Upload</h4>
        <form name="form1" onsubmit="return formCheck()">
          <div class="input-group mb-3">
            <div class="input-group-prepend">
              <span class="input-group-text">Upload</span>
            </div>
            <div class="custom-file">
              <label class="custom-file-label" for="food">Choose file</label>
              <input type="file" class="custom-file-input" accept="image/*" id="food" name="food">
            </div>
          </div>
        </form>
      </div>
      <div class="row">
        <img id="myimg" width="100%" src="" alt="">
      </div>
    </div>

    
    <div class="col-lg-6"> 
      <h3>食物資料</h3>   
        <table id='nutri' class="table table-striped table-sm">
          <thead>
            <tr>
              <th>熱量</th>
              <th>蛋白質</th>
              <th>脂肪</th>
              <th>碳水化合物</th>
            </tr>
          </thead>
          <tbody>
            <tr class="table-active">
              <td id="fat"></td>
              <td id="carbs"></td>
              <td id="protein"></td>
              <td id="cal"></td>
            </tr>
          </tbody>
        </table>    
    </div>
  </div>
</div>


<div class="col ml-5">
<div class="col-lg-4 mt-2">
  <h2><label for="validationCustom04">Gender</label></h2>
  <select class="custom-select" id="gender_sel" required>
    <option selected disabled value="">Choose...</option>
    <option value="m">Male</option>
    <option value="f">Female</option>
  </select>
</div>

<div class="col-lg-4 mt-2">
  <h2><label for="validationCustom04">Age</label></h2>
  <select class="custom-select" id="age_sel" required>
    <option selected disabled value="">Choose...</option>
    <option value="500">10~20</option>
    <option value="300">20~30</option>
    <option value="200">30~40</option>
    <option value="100">40~50</option>
    <option value="50">50~60</option>
    <option value="50">60~70</option>
    <option value="50">70~80</option>
  </select>
</div>

<div class="col-lg-4 mt-2">
  <h2><label for="validationCustom04">Level</label></h2>
  <select class="custom-select" id="level_sel" required>
    <option selected disabled value="">Choose...</option>
    <option value="1">Light</option>
    <option value="2">Normal</option>
    <option value="3">Hard</option>
  </select>
</div>

<div class="col-lg-6 mt-2">
  <h2><label for="validationCustom04">可吸收熱量 :</label></h2>
  <u>
    <div class="row justify-content-center text-warning h3" id="my_info"></div>
  </u>
</div>

<div class="col-lg-6 mt-2">
  <h2><label for="validationCustom04">剩餘熱量 :</label></h2>
  <u>
    <div class="row justify-content-center text-danger h3" id="my_lastinfo"></div>
  </u>
</div>
</div>





      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">Projects</h6>
        </div>
        <div class="card-body">
          <h4 class="small font-weight-bold">Server Migration <span class="float-right">20%</span></h4>
          <div class="progress mb-4">
            <div class="progress-bar bg-danger" role="progressbar" style="width: 20%" aria-valuenow="20"
              aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <h4 class="small font-weight-bold">Sales Tracking <span class="float-right">40%</span></h4>
          <div class="progress mb-4">
            <div class="progress-bar bg-warning" role="progressbar" style="width: 40%" aria-valuenow="40"
              aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <h4 class="small font-weight-bold">Customer Database <span class="float-right">60%</span></h4>
          <div class="progress mb-4">
            <div class="progress-bar" role="progressbar" style="width: 60%" aria-valuenow="60" aria-valuemin="0"
              aria-valuemax="100"></div>
          </div>
          <h4 class="small font-weight-bold">Payout Details <span class="float-right">80%</span></h4>
          <div class="progress mb-4">
            <div class="progress-bar bg-info" role="progressbar" style="width: 80%" aria-valuenow="80" aria-valuemin="0"
              aria-valuemax="100"></div>
          </div>
          <h4 class="small font-weight-bold">Account Setup <span class="float-right">Complete!</span></h4>
          <div class="progress">
            <div class="progress-bar bg-success" role="progressbar" style="width: 100%" aria-valuenow="100"
              aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </div>
      </div>


      <script src="/js/jquery-3.5.1.js"></script>
      <script src="/bootstrap/js/bootstrap.bundle.js"></script>
      <!-- <script>

          console.log("loading page1")
        
            function formCheck(){
              console.log("exec formCheck")
                $.post(
                    '/try-upload',
                    $(document.form1).serialize(),
                    function(data){
                      console.log('ajax response OK')
                        console.log(data);
                }, 'json')
                return false;
            }
        
      </script> -->
      <script>
        function formCheck() {
          const fd = new FormData(document.form1);  //FormData就是一個表單但沒有外觀
          fetch('/try-upload', {
            method: 'POST',
            body: fd
          })
            .then(r => r.json()) //拿文字的話json改text
            .then(obj => {
              console.log(obj)
              myimg.src = "/img-downloads/" + obj.filename;

              console.log(obj.data) //拿到data
              d = obj.data.match(/{.+}/)[0].replaceAll("\'", '"')
              console.log(d)
              d = JSON.parse(d)
              console.log(d)
              console.log(d.total_fat)

              console.log(document.querySelector('#nutri tbody tr td').innerText)
              //document.querySelector("#nutri tbody tr td").innerText = d.total_fat
              document.querySelector("#fat").innerText = d.total_fat
              document.querySelector("#carbs").innerText = d.total_carbs
              document.querySelector("#protein").innerText = d.total_protein
              document.querySelector("#cal").innerText = d.total_cal
            })

          return false;
        }

        food.addEventListener('change', formCheck)


        $('.dropdown-toggle').dropdown();
      </script>


      <!-- <script>
              function formCheck() {
                const fd = new FormData(document.form1);  //FormData就是一個表單但沒有外觀
                fetch('/try-upload-multi', {
                  method: 'POST',
                  body: fd
                })
                .then(r => r.json()) //拿文字的話json改text
                .then(ar => {
                    console.log(ar)
                    const imgs = $('#imgs');

                    ar.forEach(f=>{
                        imgs.append(`<div><img src="/img-uploads/${f.filename}" alt=""></div>`)
                    })
                    //myimg.src = "/img-uploads/" + obj.filename;
                })
      
                return false;
              }
      
      
              myphoto.addEventListener('change', formCheck)
            </script> -->


      <%- include("parts/scripts") %>

      <script>
        const gender_sel = $('#gender_sel');
        const age_sel = $('#age_sel');
        const level_sel = $('#level_sel');


        $('.custom-select').change(function () {

          const g = gender_sel.val();
          //const a = age_sel.val();
          const a = age_sel.val() ? parseInt(age_sel.val()) : 0;
          const l = level_sel.val();

          let cal = g === 'm' ? 2000 : 1500;

          cal += a;
          cal += l * 200;


          $('#my_info').html(cal + "卡");
          $('#my_lastinfo').html(cal - parseInt('#fat') + "卡");
        });


      </script>

      <%- include("parts/html-foot") %>